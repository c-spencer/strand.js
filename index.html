<!DOCTYPE html>
<html>
  <head>
    <title>Yield is Fun</title>
  </head>

  <script type="application/javascript;version=1.7" src="strand.js"></script>
  <script type="application/javascript;version=1.7">
    function make_async_work_2(str) {
      return function (callback) {
        setTimeout(function () {
          callback(str);
        }, 500);
      };
    }

    function fail_work(str) {
      return function (callback) {
        throw "failure!";
      }
    }

    var error0 = strand(function() {
      console.log("0a");
      throw "Boom";
      yield 1;
    });
    
    var error1 = strand(function() {
      console.log("1a");
      yield make_async_work_2('1');
      console.log("1b");
      throw "Boom";
    });
    
    var error2 = strand(function() {
      console.log("2a");
      yield make_async_work_2('1');
      console.log("2b");
      yield make_async_work_2('2');
      console.log("2c");
      throw "Boom";
    });
    
    var handleerror = strand(function() {
      try {
        console.log("a");
        yield make_async_work_2('outer');
        console.log("b");
        yield error0;
        console.log("c");
      }
      catch (e) {
        console.log("error: ", e);
      }
    });
    
    var fnGen = strand(function (d) {
      var a = 10, b, c;

      console.log("Yielding callback 1, with", d);
      [a] = yield function (callback) {
        setTimeout(function () {
          callback(20);
        }, 500);
      };

      console.log("Yielding callback 2, with", d);
      [b, c] = yield function (callback) {
        setTimeout(function () {
          callback(1, 15);
        }, 500);
      };

      console.log("a, b, c, d", a, b, c, d);
    });

    function inside_function() {
      var a, b;
      try {
        [a] = yield make_async_work_2('inside 1');
      } catch (exc) {
        console.log("Caught Exception", exc);
        a = 'thank';
      }

      try {
        [b] = yield fail_work('inside 2');
      } catch (exc) {
        console.log("Caught Exception", exc);
        b = 'goodness';
      }

      console.log("Yielding return", a + b + 'return value');

      yield a + b + 'return value';
    }

    function outside_function() {
      [b] = yield function (callback) {
        setTimeout(function () {
          strand(inside_function)(function (result) {
            console.log("Result inside b.", result);
            callback(result);
          });
        }, 500)
      }
      console.log("Yielded b");

      yield b;
    }

    //strand(outside_function)(function (result) {
    //  console.log(result + ' outside value');
    //});

    //fnGen(17, function (result) {
    //  console.log("Finished!", result);
    //});

    //fnGen(27);
    
    // handleerror(27, function(){
    //   console.log("All done!");
    // });

    function make_async_work(a, b) {
      return function (callback) {
        setTimeout(function () {
          callback(a + b);
        }, 500);
      };
    }

    var strandFn = strand(function () {
      var result;

      [result] = yield make_async_work(5, 10);
      // result == 15

      [result] = yield make_async_work(result, 20);
      // result == 35

      // Can perform work asynchronously inside a closure.
      [result] = yield function(callback) {
        setTimeout(function () {
          callback(result + 10);
        }, 500);
      }
      // result == 45

      yield result + 5;
    });

    // Call the strand with a completion callback.
    strandFn(function (return_value) {
      // return_value == 50
      console.log("Got result", return_value);
    });
  </script>

  <body>
  </body>
</html>